{"code":"import { SourceMapConsumer } from 'source-map';\n// Cache SourceMap\nlet consumer = null;\n// Create SourceMap on the first error\nconst getConsumer = function () {\n    if (consumer == null)\n        consumer = new SourceMapConsumer(require(\"main.js.map\"));\n    return consumer;\n};\n// Cache mapping to improve performance\nconst cache = {};\n/**\n * Generate a source-mapped stack trace and produce original symbols\n * Warning: The first call after global reset incurs high CPU cost (> 30 CPU)\n * Subsequent calls incur lower CPU cost (~ 0.1 CPU / call)\n *\n * @param {Error | string} error - Error or original stack trace\n * @returns {string} - Source code mapped stack trace\n */\nconst sourceMappedStackTrace = function (error) {\n    const stack = error instanceof Error ? error.stack : error;\n    if (stack === undefined) {\n        // Handle the case when stack is undefined\n        return \"\";\n    }\n    // Use the cache if available\n    if (cache.hasOwnProperty(stack))\n        return cache[stack];\n    const re = /^\\s+at\\s+(.+?\\s+)?\\(?([0-z._\\-\\\\\\/]+):(\\d+):(\\d+)\\)?$/gm;\n    let match;\n    let outStack = error.toString();\n    while ((match = re.exec(stack))) {\n        // Parsing complete\n        if (match[2] !== \"main\")\n            break;\n        // Get source mapping\n        const pos = getConsumer().originalPositionFor({\n            column: parseInt(match[4], 10),\n            line: parseInt(match[3], 10)\n        });\n        // Unable to locate\n        if (!pos.line)\n            break;\n        // Parse the stack trace\n        if (pos.name)\n            outStack += `\\n    at ${pos.name} (${pos.source}:${pos.line}:${pos.column})`;\n        else {\n            // If the corresponding file name is not found, use the original stack trace name\n            if (match[1])\n                outStack += `\\n    at ${match[1]} (${pos.source}:${pos.line}:${pos.column})`;\n            // If the corresponding file name is not found in the original stack trace as well, omit it\n            else\n                outStack += `\\n    at ${pos.source}:${pos.line}:${pos.column}`;\n        }\n    }\n    cache[stack] = outStack;\n    return outStack;\n};\n/**\n * Error tracking wrapper\n * Used to parse error information into the source code's error location via source-map\n * Different from wrapLoop, this function directly executes instead of returning a new function\n *\n * @param next - Player code\n */\nexport const errorMapper = function (next) {\n    return () => {\n        try {\n            // Execute player code\n            next();\n        }\n        catch (e) {\n            if (e instanceof Error) {\n                // Render the error call stack, cannot use source-map in sandbox mode\n                const errorMessage = Game.rooms.sim ?\n                    `Unable to use source-map in sandbox mode - displaying the original call stack<br>${_.escape(e.stack)}` :\n                    `${_.escape(sourceMappedStackTrace(e))}`;\n                console.log(`<text style=\"color:#ef9a9a\">${errorMessage}</text>`);\n            }\n            // Cannot handle, rethrow the error\n            else\n                throw e;\n        }\n    };\n};\n//# sourceMappingURL=errorMapper.js.map","references":["E:/Github/ScreepsKiller/node_modules/source-map/source-map.d.ts"],"map":"{\"version\":3,\"file\":\"errorMapper.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/modules/errorMapper.ts\"],\"names\":[],\"mappings\":\"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\"}"}
